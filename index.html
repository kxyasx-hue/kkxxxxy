            // ä¿å­˜è·¯çº¿å›¾ç‰‡ï¼ˆæ‰‹æœºç«¯ä¼˜åŒ–ï¼‰
            document.getElementById('saveBtn').addEventListener('click', function() {
                if (routePoints.length < 2) {
                    alert('è·¯çº¿ç‚¹ä½è¿‡å°‘ï¼æ— æ³•ä¿å­˜');
                    return;
                }

                const watermarkColor = document.getElementById('watermarkColor').value;
                const watermarkSize = document.getElementById('watermarkSize').value + 'px';
                const now = new Date();
                const timeStr = now.getFullYear() + '-' + 
                                (now.getMonth()+1).toString().padStart(2, '0') + '-' + 
                                now.getDate().toString().padStart(2, '0') + ' ' + 
                                now.getHours().toString().padStart(2, '0') + ':' + 
                                now.getMinutes().toString().padStart(2, '0') + ':' + 
                                now.getSeconds().toString().padStart(2, '0');

                map.plugin(['AMap.MapSnapshot'], function() {
                    const snapshot = new AMap.MapSnapshot(map, {
                        width: map.getSize().width,
                        height: map.getSize().height,
                        visible: true
                    });

                    snapshot.on('complete', function(data) {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        
                        img.crossOrigin = 'anonymous';
                        img.onload = function() {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            
                            // ç»˜åˆ¶æ—¶é—´æ°´å°ï¼ˆå³ä¸‹è§’ï¼Œé€‚é…æ‰‹æœºï¼‰
                            ctx.font = watermarkSize + ' "å¾®è½¯é›…é»‘"';
                            ctx.fillStyle = watermarkColor;
                            ctx.textAlign = 'right';
                            ctx.textBaseline = 'bottom';
                            ctx.fillText(timeStr, canvas.width - 10, canvas.height - 10);
                            
                            // æ‰‹æœºç«¯å…¼å®¹ä¿å­˜é€»è¾‘
                            try {
                                const dataUrl = canvas.toDataURL('image/png');
                                const link = document.createElement('a');
                                link.href = dataUrl;
                                link.download = 'æ•£æ­¥è·¯çº¿_' + timeStr.replace(/:/g, '-') + '.png';
                                // é€‚é…æ‰‹æœºè§¦æ‘¸ç‚¹å‡»
                                link.dispatchEvent(new MouseEvent('click', {
                                    bubbles: true,
                                    cancelable: true,
                                    view: window
                                }));
                                alert('âœ… ä¿å­˜æˆåŠŸï¼\nğŸ“± æŸ¥çœ‹ï¼šæ–‡ä»¶ç®¡ç† â†’ ä¸‹è½½ æˆ– ç›¸å†Œ â†’ ä¸‹è½½ç›¸å†Œ');
                            } catch (e) {
                                // å¤‡ç”¨æ–¹æ¡ˆï¼šæ˜¾ç¤ºå›¾ç‰‡+æç¤ºæ‰‹åŠ¨æˆªå›¾
                                const modal = document.createElement('div');
                                modal.className = 'preview-modal';
                                const imgPreview = new Image();
                                imgPreview.className = 'preview-img';
                                imgPreview.src = canvas.toDataURL('image/png');
                                const closeBtn = document.createElement('button');
                                closeBtn.className = 'close-btn';
                                closeBtn.textContent = 'å…³é—­ï¼ˆå·²æˆªå›¾ï¼‰';
                                closeBtn.onclick = function() {
                                    document.body.removeChild(modal);
                                };
                                modal.appendChild(imgPreview);
                                modal.appendChild(closeBtn);
                                document.body.appendChild(modal);
                                alert('âš ï¸ è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æˆªå›¾ï¼\nå®‰å“ï¼šç”µæºé”®+éŸ³é‡å‡\niOSï¼šç”µæºé”®+éŸ³é‡åŠ ');
                            }
                        };
                        
                        img.src = data;
                    });

                    snapshot.take();
                });
            });

            // è·¯çº¿é¢œè‰²å®æ—¶æ›´æ–°
            document.getElementById('routeColor').addEventListener('change', function() {
                if (routeLine) {
                    updateRouteLine();
                }
            });
        }

        // æ›´æ–°è·¯çº¿æ˜¾ç¤ºï¼ˆé€‚é…æ‰‹æœºï¼‰
        function updateRouteLine() {
            if (routeLine) {
                map.remove(routeLine);
            }

            if (routePoints.length < 2) {
                return;
            }

            routeLine = new AMap.Polyline({
                path: routePoints,
                strokeColor: document.getElementById('routeColor').value,
                strokeWeight: 6, // æ‰‹æœºç«¯çº¿æ¡ç¨ç²—ï¼Œæ›´æ¸…æ™°
                strokeOpacity: 0.9,
                strokeStyle: 'solid'
            });

            map.add(routeLine);
            map.setFitView([routeLine]);
        }

        // é€‚é…æ‰‹æœºè¿”å›é”®
        document.addEventListener('backbutton', function() {
            if (document.querySelector('.preview-modal')) {
                document.body.removeChild(document.querySelector('.preview-modal'));
            }
        });
    </script>
</body>
</html>
